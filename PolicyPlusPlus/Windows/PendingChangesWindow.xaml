<?xml version="1.0" encoding="utf-8"?>
<Window
  x:Class="PolicyPlusPlus.Windows.PendingChangesWindow"
  xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
  xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
  xmlns:controls="using:Microsoft.UI.Xaml.Controls"
  xmlns:toolkit="using:CommunityToolkit.WinUI.UI.Controls"
  xmlns:conv="using:PolicyPlusPlus.Converters"
  mc:Ignorable="d"
  Title="Pending changes"
>
  <Window.SystemBackdrop>
    <MicaBackdrop />
  </Window.SystemBackdrop>
  <!-- Scale host for DPI-independent scaling -->
  <Grid x:Name="ScaleHost">
    <Grid
      x:Name="RootShell"
      Background="{ThemeResource WindowBackground}"
      Padding="12"
      MinWidth="720"
      MinHeight="480"
      KeyboardAcceleratorPlacementMode="Hidden"
    >
      <Grid.Resources>
        <conv:BoolToVisibilityConverter x:Key="BoolToVisibility" />
        <conv:BoolToAngleConverter x:Key="BoolToAngle" />
        <Style x:Key="FlatToggle" TargetType="ToggleButton">
          <Setter Property="Background" Value="Transparent" />
          <Setter Property="BorderThickness" Value="0" />
          <Setter Property="Padding" Value="0" />
          <Setter Property="HorizontalAlignment" Value="Stretch" />
          <Setter Property="HorizontalContentAlignment" Value="Left" />
        </Style>
      </Grid.Resources>
      <Grid.RowDefinitions>
        <RowDefinition Height="Auto" />
        <RowDefinition Height="Auto" />
        <RowDefinition Height="*" />
        <RowDefinition Height="Auto" />
      </Grid.RowDefinitions>
      <Grid.KeyboardAccelerators>
        <KeyboardAccelerator Key="S" Modifiers="Control" Invoked="Accel_SaveAll" />
        <KeyboardAccelerator Key="Enter" Modifiers="Control" Invoked="Accel_SaveSelected" />
        <KeyboardAccelerator Key="Delete" Invoked="Accel_DiscardSelected" />
        <KeyboardAccelerator Key="D" Modifiers="Control" Invoked="Accel_DiscardAll" />
        <KeyboardAccelerator Key="F" Modifiers="Control" Invoked="Accel_FocusSearch" />
        <KeyboardAccelerator Key="Number1" Modifiers="Control" Invoked="Accel_TabPending" />
        <KeyboardAccelerator Key="Number2" Modifiers="Control" Invoked="Accel_TabHistory" />
        <KeyboardAccelerator Key="W" Modifiers="Control" Invoked="Accel_Close" />
        <KeyboardAccelerator Key="Escape" Invoked="Accel_Close" />
      </Grid.KeyboardAccelerators>
      <controls:InfoBar
        x:Name="LocalStatusBar"
        Grid.RowSpan="4"
        VerticalAlignment="Top"
        HorizontalAlignment="Stretch"
        Margin="12"
        Background="{ThemeResource SolidBackgroundFillColorBaseBrush}"
        IsOpen="False"
        Severity="Informational"
        Canvas.ZIndex="5"
      />
      <!-- header and filters -->
      <Grid Grid.Row="0" Margin="0,0,0,8">
        <StackPanel Orientation="Vertical" Spacing="2">
          <TextBlock
            x:Name="WindowTitleText"
            Text="Pending changes"
            FontSize="18"
            FontWeight="SemiBold"
            AutomationProperties.Name="Pending and history changes window title"
          />
          <TextBlock
            x:Name="SummaryText"
            Opacity="0.85"
            AutomationProperties.Name="Summary of pending and history items"
          />
        </StackPanel>
      </Grid>
      <controls:TabView
        Grid.Row="2"
        x:Name="MainTabs"
        TabWidthMode="Equal"
        IsAddTabButtonVisible="False"
        CanReorderTabs="False"
        CanDragTabs="False"
        SelectedIndex="0"
        SelectionChanged="MainTabs_SelectionChanged"
      >
        <controls:TabViewItem
          x:Name="PendingTab"
          Header="Pending"
          IsClosable="False"
          AutomationProperties.Name="Pending changes tab"
        >
          <Grid Padding="4">
            <Grid.RowDefinitions>
              <RowDefinition Height="Auto" />
              <RowDefinition Height="*" />
            </Grid.RowDefinitions>
            <!-- Pending-specific search and clear controls moved inside the Pending tab -->
            <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="8" Margin="0,0,0,8">
              <TextBlock
                Text="Scope:"
                VerticalAlignment="Center"
                AutomationProperties.Name="Scope filter label"
              />
              <ComboBox
                x:Name="ScopeFilter"
                Width="120"
                SelectionChanged="ScopeFilter_SelectionChanged"
                AutomationProperties.Name="Pending scope filter"
              >
                <ComboBoxItem Content="Both" IsSelected="True" />
                <ComboBoxItem Content="Computer" />
                <ComboBoxItem Content="User" />
              </ComboBox>
              <TextBlock
                Text="Type:"
                VerticalAlignment="Center"
                AutomationProperties.Name="Type filter label"
              />
              <ComboBox
                x:Name="OperationFilter"
                Width="140"
                SelectionChanged="OperationFilter_SelectionChanged"
                AutomationProperties.Name="Pending action type filter"
              >
                <ComboBoxItem Content="All" IsSelected="True" />
                <ComboBoxItem Content="Enable" />
                <ComboBoxItem Content="Disable" />
                <ComboBoxItem Content="Clear" />
              </ComboBox>
              <AutoSuggestBox
                x:Name="SearchBox"
                Width="300"
                QueryIcon="Find"
                PlaceholderText="Search pending items"
                TextChanged="SearchBox_TextChanged"
                AutomationProperties.Name="Pending search box"
              />
              <!-- Clear filters button removed -->
            </StackPanel>
            <toolkit:DataGrid
              Grid.Row="1"
              x:Name="PendingList"
              AutoGenerateColumns="False"
              IsReadOnly="True"
              CanUserSortColumns="True"
              SelectionMode="Extended"
              RowDetailsVisibilityMode="VisibleWhenSelected"
              ScrollViewer.HorizontalScrollBarVisibility="Auto"
              ScrollViewer.HorizontalScrollMode="Auto"
              DoubleTapped="PendingList_DoubleTapped"
              AutomationProperties.Name="Pending changes list"
            >
              <toolkit:DataGrid.Columns>
                <toolkit:DataGridTextColumn
                  Header="Policy"
                  Binding="{Binding PolicyName}"
                  Width="300"
                />
                <toolkit:DataGridTextColumn
                  Header="Action"
                  Binding="{Binding Action}"
                  Width="140"
                />
                <toolkit:DataGridTextColumn Header="Scope" Binding="{Binding Scope}" Width="120" />
                <toolkit:DataGridTextColumn
                  Header="Details"
                  Binding="{Binding Details}"
                  Width="360"
                />
              </toolkit:DataGrid.Columns>
              <toolkit:DataGrid.RowDetailsTemplate>
                <DataTemplate>
                  <TextBlock Text="{Binding DetailsFull}" TextWrapping="Wrap" Opacity="0.85" />
                </DataTemplate>
              </toolkit:DataGrid.RowDetailsTemplate>
              <toolkit:DataGrid.RowStyle>
                <Style TargetType="toolkit:DataGridRow">
                  <Setter Property="ContextFlyout">
                    <Setter.Value>
                      <MenuFlyout>
                        <MenuFlyoutItem Text="Save" Click="Pending_ContextApply_Click" />
                        <MenuFlyoutItem Text="Discard" Click="Pending_ContextDiscard_Click" />
                        <MenuFlyoutSeparator />
                        <MenuFlyoutItem
                          Text="View formatted..."
                          Click="Pending_ContextView_Click"
                        />
                        <MenuFlyoutItem
                          Text="Copy registry path"
                          Click="Pending_ContextCopyRegPath_Click"
                        />
                      </MenuFlyout>
                    </Setter.Value>
                  </Setter>
                </Style>
              </toolkit:DataGrid.RowStyle>
            </toolkit:DataGrid>
          </Grid>
        </controls:TabViewItem>
        <controls:TabViewItem
          x:Name="HistoryTab"
          Header="History"
          IsClosable="False"
          AutomationProperties.Name="History tab"
        >
          <Grid Padding="4">
            <Grid.RowDefinitions>
              <RowDefinition Height="Auto" />
              <RowDefinition Height="*" />
            </Grid.RowDefinitions>
            <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="8" Margin="0,0,0,4">
              <TextBlock
                Text="Scope:"
                VerticalAlignment="Center"
                AutomationProperties.Name="History scope filter label"
              />
              <ComboBox
                x:Name="HistoryScope"
                Width="120"
                SelectionChanged="HistoryFilter_Changed"
                AutomationProperties.Name="History scope filter"
              >
                <ComboBoxItem Content="Both" IsSelected="True" />
                <ComboBoxItem Content="Computer" />
                <ComboBoxItem Content="User" />
              </ComboBox>
              <TextBlock
                Text="Type:"
                VerticalAlignment="Center"
                AutomationProperties.Name="History type filter label"
              />
              <ComboBox
                x:Name="HistoryType"
                Width="140"
                SelectionChanged="HistoryFilter_Changed"
                AutomationProperties.Name="History action type filter"
              >
                <ComboBoxItem Content="All" IsSelected="True" />
                <ComboBoxItem Content="Applied" />
                <ComboBoxItem Content="Discarded" />
                <ComboBoxItem Content="Reapplied" />
              </ComboBox>
              <TextBlock
                Text="Time:"
                VerticalAlignment="Center"
                AutomationProperties.Name="History time range filter label"
              />
              <ComboBox
                x:Name="HistoryTimeRange"
                Width="140"
                SelectionChanged="HistoryFilter_Changed"
                AutomationProperties.Name="History time range filter"
              >
                <ComboBoxItem Content="All" IsSelected="True" />
                <ComboBoxItem Content="Today" />
                <ComboBoxItem Content="Last 7 days" />
                <ComboBoxItem Content="Last 30 days" />
              </ComboBox>
              <AutoSuggestBox
                x:Name="HistorySearch"
                Width="260"
                QueryIcon="Find"
                PlaceholderText="Search history"
                TextChanged="HistorySearch_TextChanged"
                AutomationProperties.Name="History search box"
              />
              <!-- Clear history filters button removed -->
            </StackPanel>
            <toolkit:DataGrid
              Grid.Row="1"
              x:Name="HistoryList"
              AutoGenerateColumns="False"
              IsReadOnly="True"
              CanUserSortColumns="True"
              SelectionMode="Extended"
              RowDetailsVisibilityMode="VisibleWhenSelected"
              ScrollViewer.HorizontalScrollBarVisibility="Auto"
              ScrollViewer.HorizontalScrollMode="Auto"
              DoubleTapped="HistoryList_DoubleTapped"
              AutomationProperties.Name="History changes list"
            >
              <toolkit:DataGrid.Columns>
                <toolkit:DataGridTextColumn
                  Header="Policy"
                  Binding="{Binding PolicyName}"
                  Width="300"
                />
                <toolkit:DataGridTextColumn
                  Header="Action"
                  Binding="{Binding Action}"
                  Width="140"
                />
                <toolkit:DataGridTextColumn Header="Scope" Binding="{Binding Scope}" Width="120" />
                <toolkit:DataGridTextColumn
                  Header="Applied at"
                  Binding="{Binding AppliedAt}"
                  Width="180"
                />
                <toolkit:DataGridTextColumn
                  Header="Details"
                  Binding="{Binding Details}"
                  Width="400"
                />
              </toolkit:DataGrid.Columns>
              <toolkit:DataGrid.RowDetailsTemplate>
                <DataTemplate>
                  <TextBlock Text="{Binding DetailsFull}" TextWrapping="Wrap" Opacity="0.85" />
                </DataTemplate>
              </toolkit:DataGrid.RowDetailsTemplate>
            </toolkit:DataGrid>
          </Grid>
        </controls:TabViewItem>
      </controls:TabView>
      <Grid Grid.Row="3" Margin="0,8,0,0">
        <Grid.ColumnDefinitions>
          <ColumnDefinition />
          <ColumnDefinition Width="Auto" />
          <ColumnDefinition Width="Auto" />
          <ColumnDefinition Width="Auto" />
          <ColumnDefinition Width="Auto" />
        </Grid.ColumnDefinitions>
        <StackPanel Orientation="Horizontal" Spacing="8">
          <Button
            x:Name="BtnApplySelected"
            Content="Save selected"
            Style="{StaticResource PrimaryButtonStyle}"
            Click="BtnApplySelected_Click"
            AutomationProperties.Name="Save selected pending changes"
          />
          <Button
            x:Name="BtnDiscardSelected"
            Content="Discard selected"
            Click="BtnDiscardSelected_Click"
            AutomationProperties.Name="Discard selected pending changes"
          />
        </StackPanel>
        <Button
          x:Name="BtnApplyAll"
          Grid.Column="1"
          Content="Save all"
          Click="BtnSaveAll_Click"
          AutomationProperties.Name="Save all pending changes"
        />
        <Button
          x:Name="BtnDiscardAll"
          Grid.Column="2"
          Content="Discard all"
          Click="BtnDiscardAll_Click"
          AutomationProperties.Name="Discard all pending changes"
        />
        <Button
          x:Name="BtnReapplySelected"
          Grid.Column="3"
          Content="Reapply &amp; Save selected"
          Click="BtnReapplySelected_Click"
          AutomationProperties.Name="Reapply and save selected history items"
        />
        <Button
          x:Name="BtnClose"
          Grid.Column="4"
          Content="Close"
          AutomationProperties.Name="Close pending changes window"
        />
      </Grid>
      <Grid
        x:Name="SavingOverlay"
        Background="#80000000"
        Visibility="Collapsed"
        Canvas.ZIndex="99"
        AutomationProperties.Name="Saving overlay"
      >
        <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="8">
          <controls:ProgressRing
            IsActive="True"
            Width="48"
            Height="48"
            AutomationProperties.Name="Saving in progress"
          />
          <TextBlock Text="Saving..." AutomationProperties.Name="Saving status text" />
        </StackPanel>
      </Grid>
    </Grid>
  </Grid>
</Window>
