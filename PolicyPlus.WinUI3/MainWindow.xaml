<?xml version="1.0" encoding="utf-8"?>
<Window
    x:Class="PolicyPlus.WinUI3.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:controls="using:Microsoft.UI.Xaml.Controls"
    xmlns:toolkit="using:CommunityToolkit.WinUI.Controls"
    xmlns:converters="using:PolicyPlus.WinUI3.Converters"
    mc:Ignorable="d"
    Title="PolicyPlus">

    <Window.SystemBackdrop>
        <MicaBackdrop />
    </Window.SystemBackdrop>

    <Grid x:Name="RootGrid" Background="{ThemeResource WindowBackground}" Loaded="Window_Loaded" KeyDown="RootGrid_KeyDown">
        <Grid.KeyboardAccelerators>
            <KeyboardAccelerator Key="S" Modifiers="Control" Invoked="SaveAccelerator_Invoked"/>
        </Grid.KeyboardAccelerators>
        <Grid.Resources>
            <converters:ScaleConverter x:Key="ScaleConverter"/>
            <converters:CategoryVisibilityConverter x:Key="CategoryVisibilityConverter"/>
            <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
            <converters:NotBoolToVisibilityConverter x:Key="NotBoolToVisibilityConverter"/>
        </Grid.Resources>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Overlay InfoBar at the bottom, with denser background -->
        <controls:InfoBar x:Name="StatusBar"
                          Grid.RowSpan="2"
                          VerticalAlignment="Bottom"
                          HorizontalAlignment="Stretch"
                          Margin="12"
                          Background="{ThemeResource SolidBackgroundFillColorBaseBrush}"
                          IsOpen="False"
                          Severity="Informational"
                          Canvas.ZIndex="5" />

        <Grid Grid.Row="1">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Menu bar and theme selector -->
            <Grid Grid.Row="0" Margin="8,8,8,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition />
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <controls:MenuBar>
                    <controls:MenuBarItem Title="File">
                        <MenuFlyoutItem Text="Load Local GPO (Computer)" Click="BtnLoadLocalGpo_Click" />
                        <MenuFlyoutItem Text="Load ADMX Folder..." Click="BtnLoadAdmxFolder_Click" />
                        <MenuFlyoutSeparator/>
                        <MenuFlyoutItem Text="Save" Click="BtnSave_Click" />
                    </controls:MenuBarItem>
                    <controls:MenuBarItem Title="Find">
                        <MenuFlyoutItem Text="Find..." Click="BtnFind_Click" />
                        <MenuFlyoutItem Text="Find by registry..." Click="BtnFindReg_Click" />
                        <MenuFlyoutItem Text="Find by ID..." Click="BtnFindId_Click" />
                    </controls:MenuBarItem>
                    <controls:MenuBarItem Title="Import/Export">
                        <MenuFlyoutItem Text="Export .reg..." Click="BtnExportReg_Click" />
                        <MenuFlyoutItem Text="Export CSV..." Click="BtnExportCsv_Click" />
                        <MenuFlyoutSeparator/>
                        <MenuFlyoutItem Text="Import .pol..." Click="BtnImportPol_Click" />
                        <MenuFlyoutItem Text="Import .reg..." Click="BtnImportReg_Click" />
                    </controls:MenuBarItem>
                    <controls:MenuBarItem Title="Options">
                        <MenuFlyoutItem Text="Language..." Click="BtnLanguage_Click" />
                        <ToggleMenuFlyoutItem x:Name="ToggleTempPolMenu" Text="Write to temp .pol" IsChecked="{Binding IsChecked, ElementName=ChkUseTempPol, Mode=TwoWay}" Click="ToggleTempPolMenu_Click" />
                        <ToggleMenuFlyoutItem x:Name="ToggleHideEmptyMenu" Text="Hide empty categories" IsChecked="True" Click="ToggleHideEmptyMenu_Click" />
                    </controls:MenuBarItem>
                    <!-- New menu for Pending/History -->
                    <controls:MenuBarItem Title="Changes">
                        <MenuFlyoutItem Text="Pending/History..." Click="BtnPendingChanges_Click" />
                    </controls:MenuBarItem>
                </controls:MenuBar>

                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                    <TextBlock Text="Theme:" VerticalAlignment="Center"/>
                    <ComboBox x:Name="ThemeSelector" Width="160" SelectionChanged="ThemeSelector_SelectionChanged">
                        <ComboBoxItem Content="System" IsSelected="True"/>
                        <ComboBoxItem Content="Dark"/>
                        <ComboBoxItem Content="Light"/>
                    </ComboBox>
                    <TextBlock x:Name="LoaderInfo" VerticalAlignment="Center"/>
                    <TextBlock x:Name="UnsavedIndicator" Text="â€¢ Unsaved changes" Foreground="OrangeRed" Visibility="Collapsed" VerticalAlignment="Center"/>
                </StackPanel>
            </Grid>

            <!-- Filters and counts row (removed Load ADMX button) -->
            <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center" Margin="8,4,8,0">
                <TextBlock Text="Applies to:" VerticalAlignment="Center"/>
                <ComboBox x:Name="AppliesToSelector" Width="140" SelectionChanged="AppliesToSelector_SelectionChanged">
                    <ComboBoxItem Content="Both" IsSelected="True"/>
                    <ComboBoxItem Content="Computer"/>
                    <ComboBoxItem Content="User"/>
                </ComboBox>
                <TextBlock Text="|" VerticalAlignment="Center"/>
                <CheckBox x:Name="ChkConfiguredOnly" Content="Configured only" Checked="ChkConfiguredOnly_Checked" Unchecked="ChkConfiguredOnly_Checked"/>
                <TextBlock Text="|" VerticalAlignment="Center"/>
                <TextBlock x:Name="PolicyCount" VerticalAlignment="Center"/>
                <!-- Keep hidden checkbox to mirror menu toggle state -->
                <CheckBox x:Name="ChkUseTempPol" Content="Write to temp .pol" Visibility="Collapsed" Checked="ChkUseTempPol_Checked" Unchecked="ChkUseTempPol_Checked"/>
            </StackPanel>

            <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="8" Margin="8,4,8,0">
                <AutoSuggestBox x:Name="SearchBox" Width="400" QueryIcon="Find" PlaceholderText="Search policies (name, id)" TextChanged="SearchBox_TextChanged" QuerySubmitted="SearchBox_QuerySubmitted" SuggestionChosen="SearchBox_SuggestionChosen"/>
                <Button x:Name="BtnClearAll" Content="Clear all filters" Click="BtnClearAll_Click"/>
                <Button x:Name="BtnEditSelected" Content="Edit selected..." Click="BtnEditSelected_Click"/>
                <Button x:Name="BtnViewFormatted" Content="View formatted..." Click="BtnViewFormatted_Click"/>
                <!-- New toolbar button -->
                <Button x:Name="BtnShowPending" Content="Pending changes..." Click="BtnPendingChanges_Click"/>
            </StackPanel>

            <Grid Grid.Row="3" Margin="8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition x:Name="CategoryColumn" Width="260" MinWidth="140"/>
                    <ColumnDefinition Width="8"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <Grid Grid.Column="0">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <Button Content="Clear category filter" Margin="0,0,0,4" Click="ClearCategoryFilter_Click"/>
                    <controls:TreeView x:Name="CategoryTree" Grid.Row="1" SelectionMode="Single" ItemInvoked="CategoryTree_ItemInvoked" SelectionChanged="CategoryTree_SelectionChanged" DoubleTapped="CategoryTree_DoubleTapped">
                        <controls:TreeView.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Content.DisplayName}" />
                            </DataTemplate>
                        </controls:TreeView.ItemTemplate>
                    </controls:TreeView>
                </Grid>
                <toolkit:GridSplitter Grid.Column="1" ResizeDirection="Columns" ResizeBehavior="PreviousAndNext" Width="8" HorizontalAlignment="Stretch"/>

                <Grid Grid.Column="2">
                    <!-- Default 7:3 split; user-resizable via splitter placed above the policy name block -->
                    <Grid.RowDefinitions>
                        <RowDefinition Height="7*"/>
                        <RowDefinition Height="8"/>
                        <RowDefinition Height="3*"/>
                    </Grid.RowDefinitions>
                    <ListView x:Name="PolicyList" Grid.Row="0" SelectionChanged="PolicyList_SelectionChanged" IsItemClickEnabled="False" DoubleTapped="PolicyList_DoubleTapped" RightTapped="PolicyList_RightTapped">
                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <!-- Category icon -->
                                    <FontIcon Grid.Column="0" Glyph="&#xE8B7;" Opacity="0.8" Visibility="{Binding IsCategory, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                    <!-- Stacked icons for User/Computer with darker base icon -->
                                    <Grid Grid.Column="1" Margin="0,0,8,0" Visibility="{Binding UserConfigured, Converter={StaticResource BoolToVisibilityConverter}}">
                                        <FontIcon Glyph="&#xE77B;" Foreground="{ThemeResource TextFillColorPrimaryBrush}" Opacity="0.85"/>
                                        <FontIcon Glyph="{Binding UserGlyph}" Foreground="{ThemeResource AccentBrush}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        <ToolTipService.ToolTip>
                                            <ToolTip Content="User"/>
                                        </ToolTipService.ToolTip>
                                    </Grid>
                                    <Grid Grid.Column="2" Margin="0,0,8,0" Visibility="{Binding ComputerConfigured, Converter={StaticResource BoolToVisibilityConverter}}">
                                        <FontIcon Glyph="&#xE211;" Foreground="{ThemeResource TextFillColorPrimaryBrush}" Opacity="0.85"/>
                                        <FontIcon Glyph="{Binding ComputerGlyph}" Foreground="{ThemeResource AccentBrush}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        <ToolTipService.ToolTip>
                                            <ToolTip Content="Computer"/>
                                        </ToolTipService.ToolTip>
                                    </Grid>
                                    <TextBlock Grid.Column="3" Text="{Binding DisplayName}"/>
                                </Grid>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                        <ListView.ItemContainerStyle>
                            <Style TargetType="ListViewItem">
                                <Setter Property="ContextFlyout">
                                    <Setter.Value>
                                        <MenuFlyout>
                                            <MenuFlyoutItem Text="Edit..." Tag="{Binding Policy}" Click="ContextEdit_Click" />
                                            <MenuFlyoutItem Text="View formatted..." Tag="{Binding Policy}" Click="ContextViewFormatted_Click" />
                                            <MenuFlyoutSeparator />
                                            <MenuFlyoutItem Text="Copy name" Tag="{Binding Policy}" Click="ContextCopyName_Click" />
                                            <MenuFlyoutItem Text="Copy ID" Tag="{Binding Policy}" Click="ContextCopyId_Click" />
                                            <MenuFlyoutItem Text="Copy path" Tag="{Binding Policy}" Click="ContextCopyPath_Click" />
                                            <MenuFlyoutItem Text="Reveal in tree" Tag="{Binding Policy}" Click="ContextRevealInTree_Click" />
                                            <MenuFlyoutItem Text="Copy .reg export" Tag="{Binding Policy}" Click="ContextCopyRegExport_Click" />
                                        </MenuFlyout>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </ListView.ItemContainerStyle>
                    </ListView>
                    <toolkit:GridSplitter Grid.Row="1" ResizeDirection="Rows" ResizeBehavior="PreviousAndNext" Height="8" HorizontalAlignment="Stretch"/>
                    <Border Grid.Row="2" Margin="0,8,0,0" Padding="12" Background="{ThemeResource LayerOnMicaBaseAltFillColorDefaultBrush}" CornerRadius="4" MinHeight="80">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <StackPanel Grid.Row="0" Spacing="2">
                                <RichTextBlock x:Name="DetailTitle" FontSize="16" FontWeight="SemiBold" IsTextSelectionEnabled="True" TextWrapping="Wrap"/>
                                <RichTextBlock x:Name="DetailId" Opacity="0.8" IsTextSelectionEnabled="True" TextWrapping="Wrap"/>
                                <RichTextBlock x:Name="DetailCategory" Opacity="0.8" IsTextSelectionEnabled="True" TextWrapping="Wrap"/>
                                <RichTextBlock x:Name="DetailApplies" Opacity="0.8" IsTextSelectionEnabled="True" TextWrapping="Wrap"/>
                                <RichTextBlock x:Name="DetailSupported" Opacity="0.8" IsTextSelectionEnabled="True" TextWrapping="Wrap"/>
                            </StackPanel>
                            <ScrollViewer Grid.Row="1" x:Name="DetailExplainScroll" VerticalScrollBarVisibility="Auto">
                                <RichTextBlock x:Name="DetailExplain" IsTextSelectionEnabled="True" TextWrapping="Wrap"/>
                            </ScrollViewer>
                        </Grid>
                    </Border>
                </Grid>
            </Grid>
        </Grid>

        <Grid x:Name="BusyOverlay" Background="#80000000" Visibility="Collapsed" Grid.RowSpan="2" Canvas.ZIndex="10">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="8">
                <controls:ProgressRing IsActive="True" Width="48" Height="48"/>
                <TextBlock Text="Loading..."/>
            </StackPanel>
        </Grid>
    </Grid>
</Window>
