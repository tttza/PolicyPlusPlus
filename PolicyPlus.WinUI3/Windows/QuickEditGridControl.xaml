<UserControl
    x:Class="PolicyPlus.WinUI3.Windows.QuickEditGridControl"
    x:Name="RootControl"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:conv="using:PolicyPlus.WinUI3.Converters"
    xmlns:muxc="using:Microsoft.UI.Xaml.Controls"
    xmlns:vm="using:PolicyPlus.WinUI3.ViewModels">
    <UserControl.Resources>
        <conv:BoolToVisibilityConverter x:Key="BoolToVisibility" />
        <conv:QuickEditStateToIndexConverter x:Key="StateIndex" />
        <conv:HeaderGlyphConverter x:Key="HeaderGlyph" />
        <conv:QuickEditStateToBrushConverter x:Key="StateBrush" />
    </UserControl.Resources>
    <Grid>
        <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled">
            <StackPanel>
                <!-- Header row -->
                <Grid Height="40" Background="{ThemeResource LayerFillColorDefaultBrush}">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="{Binding Columns.Name, ElementName=RootControl}" MinWidth="300" />
                        <ColumnDefinition Width="4" />
                        <ColumnDefinition Width="{Binding Columns.Id, ElementName=RootControl}" MinWidth="140" />
                        <ColumnDefinition Width="4" />
                        <ColumnDefinition Width="{Binding Columns.UserState, ElementName=RootControl}" MinWidth="150" />
                        <ColumnDefinition Width="4" />
                        <ColumnDefinition Width="260"/>
                        <ColumnDefinition Width="4" />
                        <ColumnDefinition Width="{Binding Columns.ComputerState, ElementName=RootControl}" MinWidth="150" />
                        <ColumnDefinition Width="4" />
                        <ColumnDefinition Width="260"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Column="0" Text="Name" VerticalAlignment="Center" Margin="6,0" />
                    <Thumb Grid.Column="1" Tag="Name" DragDelta="ResizeThumb_DragDelta" Background="Transparent" Opacity="0.001" />
                    <TextBlock Grid.Column="2" Text="ID" VerticalAlignment="Center" Margin="6,0" />
                    <Thumb Grid.Column="3" Tag="Id" DragDelta="ResizeThumb_DragDelta" Background="Transparent" Opacity="0.001" />
                    <TextBlock Grid.Column="4" Text="User State" VerticalAlignment="Center" Margin="6,0" />
                    <Thumb Grid.Column="5" Tag="UserState" DragDelta="ResizeThumb_DragDelta" Background="Transparent" Opacity="0.001" />
                    <TextBlock Grid.Column="6" Text="User Options" VerticalAlignment="Center" Margin="6,0" />
                    <Thumb Grid.Column="7" Tag="UserOptions" DragDelta="ResizeThumb_DragDelta" Background="Transparent" Opacity="0.001" />
                    <TextBlock Grid.Column="8" Text="Computer State" VerticalAlignment="Center" Margin="6,0" />
                    <Thumb Grid.Column="9" Tag="ComputerState" DragDelta="ResizeThumb_DragDelta" Background="Transparent" Opacity="0.001" />
                    <TextBlock Grid.Column="10" Text="Computer Options" VerticalAlignment="Center" Margin="6,0" />
                </Grid>

                <!-- Body -->
                <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollMode="Disabled" HorizontalScrollBarVisibility="Hidden" MaxHeight="600">
                    <muxc:ItemsRepeater ItemsSource="{x:Bind Rows, Mode=OneWay}">
                        <muxc:ItemsRepeater.Layout>
                            <muxc:StackLayout />
                        </muxc:ItemsRepeater.Layout>
                        <muxc:ItemsRepeater.ItemTemplate>
                            <DataTemplate x:DataType="vm:QuickEditRow">
                                <!-- Allow variable height for vertical option stacking -->
                                <Grid MinHeight="42" Padding="0,2,0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="{Binding Columns.Name, ElementName=RootControl}" MinWidth="300" />
                                        <ColumnDefinition Width="4" />
                                        <ColumnDefinition Width="{Binding Columns.Id, ElementName=RootControl}" MinWidth="140" />
                                        <ColumnDefinition Width="4" />
                                        <ColumnDefinition Width="{Binding Columns.UserState, ElementName=RootControl}" MinWidth="150" />
                                        <ColumnDefinition Width="4" />
                                        <ColumnDefinition Width="260"/>
                                        <ColumnDefinition Width="4" />
                                        <ColumnDefinition Width="{Binding Columns.ComputerState, ElementName=RootControl}" MinWidth="150" />
                                        <ColumnDefinition Width="4" />
                                        <ColumnDefinition Width="260"/>
                                    </Grid.ColumnDefinitions>

                                    <TextBlock Grid.Column="0" Text="{Binding Policy.DisplayName}" TextTrimming="CharacterEllipsis" VerticalAlignment="Center" Margin="4,0" DoubleTapped="NameText_DoubleTapped" />
                                    <TextBlock Grid.Column="2" Text="{Binding IdTail}" TextTrimming="CharacterEllipsis" VerticalAlignment="Center" Margin="4,0" />

                                    <!-- User State -->
                                    <Border Grid.Column="4" Background="{Binding UserState, Converter={StaticResource StateBrush}}" CornerRadius="4" Padding="4,2" Visibility="{Binding SupportsUser, Converter={StaticResource BoolToVisibility}}" VerticalAlignment="Center" HorizontalAlignment="Center">
                                        <ComboBox Width="150" SelectedIndex="{Binding UserState, Mode=TwoWay, Converter={StaticResource StateIndex}}">
                                            <ComboBoxItem Content="Not Configured" />
                                            <ComboBoxItem Content="Enabled" />
                                            <ComboBoxItem Content="Disabled" />
                                        </ComboBox>
                                    </Border>

                                    <!-- User Option Elements -->
                                    <ScrollViewer Grid.Column="6" Visibility="{Binding SupportsUser, Converter={StaticResource BoolToVisibility}}" HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto" IsEnabled="{Binding UserEnabledForOptions}" MaxWidth="260">
                                        <ItemsControl ItemsSource="{Binding OptionElements}">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <StackPanel Orientation="Vertical" Spacing="4" />
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate x:DataType="vm:OptionElementVM">
                                                    <StackPanel Orientation="Vertical" Spacing="2" ToolTipService.ToolTip="{x:Bind Id}">
                                                        <ComboBox Width="210" MinWidth="120" Visibility="{x:Bind IsEnum, Converter={StaticResource BoolToVisibility}}" SelectedIndex="{x:Bind UserEnumIndex, Mode=TwoWay}" ItemsSource="{x:Bind Choices}" />
                                                        <CheckBox Visibility="{x:Bind IsBoolean, Converter={StaticResource BoolToVisibility}}" IsChecked="{x:Bind UserBool, Mode=TwoWay}" Padding="4,0" />
                                                        <TextBox x:Name="UserPlainText" MinWidth="150" Width="210" Visibility="{x:Bind IsPlainText, Converter={StaticResource BoolToVisibility}}" Text="{x:Bind UserText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" MaxLength="{x:Bind TextMaxLength}" />
                                                        <AutoSuggestBox x:Name="UserSuggestBox" MinWidth="150" Width="210" Visibility="{x:Bind IsSuggestText, Converter={StaticResource BoolToVisibility}}" Text="{x:Bind UserText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" ItemsSource="{x:Bind Suggestions}" />
                                                        <NumberBox Width="110" Visibility="{x:Bind IsDecimal, Converter={StaticResource BoolToVisibility}}" Value="{x:Bind UserNumberDouble, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" SpinButtonPlacementMode="Compact" Minimum="{x:Bind DecimalMinDouble}" Maximum="{x:Bind DecimalMaxDouble}" SmallChange="{x:Bind DecimalIncrementDouble}"/>
                                                        <Button MinWidth="96" Width="110" Visibility="{x:Bind IsList, Converter={StaticResource BoolToVisibility}}" Content="{x:Bind UserListSummary}" Tag="UserList" Click="UserListDynamic_Click" />
                                                        <Button MinWidth="96" Width="110" Visibility="{x:Bind IsMultiText, Converter={StaticResource BoolToVisibility}}" Content="{x:Bind UserMultiTextSummary}" Tag="UserMulti" Click="UserMultiDynamic_Click" />
                                                    </StackPanel>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </ScrollViewer>

                                    <!-- Computer State -->
                                    <Border Grid.Column="8" Background="{Binding ComputerState, Converter={StaticResource StateBrush}}" CornerRadius="4" Padding="4,2" Visibility="{Binding SupportsComputer, Converter={StaticResource BoolToVisibility}}" VerticalAlignment="Center" HorizontalAlignment="Center">
                                        <ComboBox Width="150" SelectedIndex="{Binding ComputerState, Mode=TwoWay, Converter={StaticResource StateIndex}}">
                                            <ComboBoxItem Content="Not Configured" />
                                            <ComboBoxItem Content="Enabled" />
                                            <ComboBoxItem Content="Disabled" />
                                        </ComboBox>
                                    </Border>

                                    <!-- Computer Option Elements -->
                                    <ScrollViewer Grid.Column="10" Visibility="{Binding SupportsComputer, Converter={StaticResource BoolToVisibility}}" HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto" IsEnabled="{Binding ComputerEnabledForOptions}"  MaxWidth="260">
                                        <ItemsControl ItemsSource="{Binding OptionElements}">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <StackPanel Orientation="Vertical" Spacing="4" />
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate x:DataType="vm:OptionElementVM">
                                                    <StackPanel Orientation="Vertical" Spacing="2" ToolTipService.ToolTip="{x:Bind Id}" HorizontalAlignment="Left">
                                                        <ComboBox Width="210" MinWidth="120" Visibility="{x:Bind IsEnum, Converter={StaticResource BoolToVisibility}}" SelectedIndex="{x:Bind ComputerEnumIndex, Mode=TwoWay}" ItemsSource="{x:Bind Choices}" />
                                                        <CheckBox Visibility="{x:Bind IsBoolean, Converter={StaticResource BoolToVisibility}}" IsChecked="{x:Bind ComputerBool, Mode=TwoWay}" Padding="4,0" />
                                                        <TextBox x:Name="ComputerPlainText" MinWidth="150" Width="210" Visibility="{x:Bind IsPlainText, Converter={StaticResource BoolToVisibility}}" Text="{x:Bind ComputerText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" MaxLength="{x:Bind TextMaxLength}" />
                                                        <AutoSuggestBox x:Name="ComputerSuggestBox" MinWidth="150" Width="210" Visibility="{x:Bind IsSuggestText, Converter={StaticResource BoolToVisibility}}" Text="{x:Bind ComputerText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" ItemsSource="{x:Bind Suggestions}" />
                                                        <NumberBox Width="110" Visibility="{x:Bind IsDecimal, Converter={StaticResource BoolToVisibility}}" Value="{x:Bind ComputerNumberDouble, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" SpinButtonPlacementMode="Compact" Minimum="{x:Bind DecimalMinDouble}" Maximum="{x:Bind DecimalMaxDouble}" SmallChange="{x:Bind DecimalIncrementDouble}"/>
                                                        <Button MinWidth="96" Width="110" Visibility="{x:Bind IsList, Converter={StaticResource BoolToVisibility}}" Content="{x:Bind ComputerListSummary}" Tag="ComputerList" Click="ComputerListDynamic_Click" />
                                                        <Button MinWidth="96" Width="110" Visibility="{x:Bind IsMultiText, Converter={StaticResource BoolToVisibility}}" Content="{x:Bind ComputerMultiTextSummary}" Tag="ComputerMulti" Click="ComputerMultiDynamic_Click" />
                                                    </StackPanel>
                                                </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </ScrollViewer>
                                </Grid>
                            </DataTemplate>
                        </muxc:ItemsRepeater.ItemTemplate>
                    </muxc:ItemsRepeater>
                </ScrollViewer>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>